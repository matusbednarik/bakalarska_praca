import pandas as pd
import spacy
from tqdm.auto import tqdm

# 1) Paths – adjust if needed
INPUT_CSV = r"C:\Users\HP\Documents\bakalarka\BERT Classifier\scripts\filter_articles_by_label\filtered_malware_articles.csv"
OUTPUT_CSV = r"C:\Users\HP\Documents\bakalarka\malware_name_extraction\articles_with_malware_entities_spacy.csv"
MODEL_DIR = r"C:\Users\HP\Documents\bakalarka\malware_name_extraction\output\model-best"

def main():
    # Load your pre-filtered articles
    df = pd.read_csv(INPUT_CSV)

    # Load the fine-tuned spaCy NER model
    nlp = spacy.load(MODEL_DIR)

    # Helper: extract unique Malware entities from text
    def extract_malware(text, label="Malware"):
        doc = nlp(text)
        return list({ent.text for ent in doc.ents if ent.label_ == label})

    # Apply over the “Preprocessed_Content” column
    tqdm.pandas()
    df["malware_names"] = df["Preprocessed_Content"].progress_apply(extract_malware)

    # Drop the original text column before saving
    df = df.drop(columns=["Preprocessed_Content"])

    # Write out only metadata + malware_names
    df.to_csv(OUTPUT_CSV, index=False)
    print(f"✅ Wrote {len(df)} rows (without text) to:\n  {OUTPUT_CSV}")

if __name__ == "__main__":
    main()