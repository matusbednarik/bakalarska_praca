import pandas as pd
import ast
from collections import Counter
import matplotlib.pyplot as plt
import seaborn as sns

def main():
    # 1) Load the CSV generated by find_malware_name.py
    input_path = r'C:\Users\HP\Documents\bakalarka\malware_name_extraction\articles_with_malware_entities_spacy.csv'
    df = pd.read_csv(input_path)

    # 2) Parse the string representation of lists into real Python lists
    def parse_list(x):
        # Handle NaN values
        if pd.isna(x):
            return []
        try:
            lst = ast.literal_eval(x)
            if isinstance(lst, list):
                return lst
        except Exception:
            pass
        return []
    
    df['malware_names'] = df['malware_names'].apply(parse_list)

    # 3) Normalize & flatten all sub-lists into one list of cleaned names
    def clean_name(name):
        # Strip whitespace and common trailing punctuation, then lowercase
        cleaned = name.strip(" \n\t\r.,;:!?").lower()
        return cleaned

    all_names = []
    for sublist in df['malware_names']:
        for name in sublist:
            cleaned = clean_name(name)
            # Filter out empty strings and very short strings (likely not malware names)
            if cleaned and len(cleaned) >= 2:
                all_names.append(cleaned)

    # 4) Count frequencies
    counts = Counter(all_names)

    # 5) Sort all malware names by frequency
    items = counts.most_common()

    # 6) Print all results
    print(f"\nTotal unique malware entities found: {len(items)}")
    print(f"Total malware mentions: {sum(counts.values())}")
    print("\nMalware Entities by Frequency:")
    for entity, freq in items:
        print(f"  â€¢ {entity}: {freq}")

    # 7) Create DataFrame for better visualization
    malware_df = pd.DataFrame(items, columns=['Malware', 'Count'])
    
    # Save complete data to CSV for reference - fix path consistency
    output_csv = r'C:\Users\HP\Documents\bakalarka\malware_name_extraction\malware_frequency_table.csv'
    malware_df.to_csv(output_csv, index=False)
    print(f"\nComplete table saved to: {output_csv}")
    
    plt.figure(figsize=(12, 10))
    
    # Only show top 10 for readability
    top_n = min(10, len(malware_df))
    plot_df = malware_df.head(top_n)
    
    # Use seaborn for better styling
    ax = sns.barplot(x='Count', y='Malware', data=plot_df, palette='viridis')
    
    # Add count labels to bars
    for i, v in enumerate(plot_df['Count']):
        ax.text(v + 0.5, i, str(v), va='center')
    
    plt.title(f'Top {top_n} Malware Entities by Frequency')
    plt.tight_layout()
    
    # Save the figure - fix path consistency
    plt.savefig(r'C:\Users\HP\Documents\bakalarka\malware_name_extraction\malware_frequency_chart.png', 
                dpi=300, bbox_inches='tight')
    plt.show()

if __name__ == "__main__":
    main()